
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>comp572_photo_mosics</title><meta name="generator" content="MATLAB 9.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-11-29"><meta name="DC.source" content="comp572_photo_mosics.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><pre class="codeinput"><span class="comment">%How you downloaded the corpus of images</span>
<span class="comment">% In my project, I used flickr.photos.getRecent to get the photos</span>
<span class="comment">% downloaded. API keys and website are autogenerated on flickr.</span>

<span class="comment">%How you determine the quality of match</span>
<span class="comment">%I use mean color to match the image to a certain block. (Mean color on three channels)</span>
<span class="comment">%Then I used square of the (sum of the difference between the image and a</span>
<span class="comment">%certain block on three channels) to find the distance between the block</span>
<span class="comment">%and image. Then I choose three pictures with the least distance.</span>


<span class="comment">%A targeted image is divided into blocks, if width and height cannot be</span>
<span class="comment">%divided by block_size, then margin is utilized.</span>

<span class="comment">%Introduce randomness</span>
<span class="comment">%As I selected the three pictures with least distance, one of them is</span>
<span class="comment">%randonly chosen to be the image put into the block.</span>

infos=get_photos();
im_num = size(infos, 1);
<span class="comment">%an image is stored with the link of the images, values for the color of</span>
<span class="comment">%the image, isrgb tells whether a images is grayscale or</span>
imdata_list = struct( <span class="string">"url"</span>, cell(im_num, 1),<span class="string">"color"</span>, cell(im_num, 1), <span class="string">"isrgb"</span>, cell(im_num, 1));
<span class="keyword">for</span> i = 1:im_num
    imdata = get_flickr_images(infos(i));
    imdata_list(i) = imdata;
<span class="keyword">end</span>

im_list = imdata_list([imdata_list.isrgb] == 1);

base_url = <span class="string">"https://raw.githubusercontent.com/cpysleeper/comp572hw4/main/"</span>;
target_ims = [<span class="string">"final_photo_by_me.jpg"</span>,<span class="string">"knifes.jpg"</span>,<span class="string">"Cat03.jpg"</span>,<span class="string">"sun%20and%20hill.jpg"</span>,<span class="string">"grass%20.jpg"</span>];

<span class="keyword">for</span> i = 1:length(target_ims)
<span class="comment">%for a whole mosaic image, there are 50x50 blocks, each small block is an</span>
<span class="comment">%image</span>
    subim_size = 40;

    url = base_url + target_ims(i);
    target_im = imread(url);
    im_mosaic = generate_mosaics(target_im, im_list, subim_size);
    figure; subplot(1, 2, 1), imshow(target_im);
    subplot(1, 2, 2), imshow(im_mosaic);
<span class="keyword">end</span>
</pre><pre class="codeoutput">Warning: The following error was caught while executing 'onCleanup' class
destructor:
Error using matlab.ui.Figure/set
Invalid or deleted object.

Error in internal.matlab.publish.PublishFigures&gt;printSnap/restoreFigure (line
279)
        set(f,'PaperPosition',origPaperPosition);

Error in
internal.matlab.publish.PublishFigures&gt;@()restoreFigure(f,origPaperPosition,params,origValues)
(line 277)
resetFigureObj = onCleanup(@()restoreFigure(f, origPaperPosition, params,
origValues));

Error in onCleanup/delete (line 23)
            obj.task();

Error in internal.matlab.publish.PublishFigures&gt;printSnap (line 266)
comment = getDebugCommentForImage(f);

Error in internal.matlab.publish.PublishFigures.snapFigure (line 205)
                    feval([method 'Snap'],f,imgFilename,imageFormat,opts);

Error in internal.matlab.publish.PublishFigures/snap (line 68)
                imgFilename =
                obj.snapFigure(f,obj.options.filenameGenerator(),obj.options);

Error in internal.matlab.publish.PublishFigures/leavingCell (line 129)
                    imgFilename = snap(obj, f);

Error in snapnow&gt;leavingCell (line 212)
            newFiles = data.plugins(iPlugins).instance.leavingCell(iCell);

Error in snapnow (line 144)
                        data = leavingCell(iCell(k), data, doCapture(k));

Error in evalmxdom&gt;instrumentAndRun (line 116)
text = evalc(evalstr);

Error in evalmxdom (line 21)
[data,text,laste] =
instrumentAndRun(file,cellBoundaries,imageDir,imagePrefix,options);

Error in publish

Error in connector.internal.fevalMatlab

Error in connector.internal.fevalJSON

Error in internal.matlab.publish.captureFigures (line 15)
drawnow;

Error in internal.matlab.publish.PublishFigures/leavingCell (line 84)
            newFigures = internal.matlab.publish.captureFigures;

Error in snapnow&gt;leavingCell (line 212)
            newFiles = data.plugins(iPlugins).instance.leavingCell(iCell);

Error in snapnow (line 144)
                        data = leavingCell(iCell(k), data, doCapture(k));

Error in comp572_photo_mosics&gt;generate_mosaics (line 51)
    result = zeros(size(target_im));

Error in comp572_photo_mosics (line 41)
    im_mosaic = generate_mosaics(target_im, im_list, subim_size);

Error in evalmxdom&gt;instrumentAndRun (line 116)
text = evalc(evalstr);

Error in evalmxdom (line 21)
[data,text,laste] =
instrumentAndRun(file,cellBoundaries,imageDir,imagePrefix,options);

Error in publish

Error in connector.internal.fevalMatlab

Error in connector.internal.fevalJSON 
Error using internal.matlab.publish.PublishFigures&gt;printSnap
Unable to write to /Users/cpysleeper/Desktop/html/comp572_photo_mosics_05.png.
FILEATTRIB output is

  archive:NaN
  system:NaN
  hidden:NaN
  directory:0
  UserRead:1
  UserWrite:1
  UserExecute:0
  GroupRead:1
  GroupWrite:0
  GroupExecute:0
  OtherRead:1
  OtherWrite:0
  OtherExecute:0

Error in internal.matlab.publish.PublishFigures.snapFigure (line 205)
                    feval([method 'Snap'],f,imgFilename,imageFormat,opts);

Error in internal.matlab.publish.PublishFigures/snap (line 68)
                imgFilename = obj.snapFigure(f,obj.options.filenameGenerator(),obj.options);

Error in internal.matlab.publish.PublishFigures/leavingCell (line 129)
                    imgFilename = snap(obj, f);

Error in snapnow&gt;leavingCell (line 212)
            newFiles = data.plugins(iPlugins).instance.leavingCell(iCell);

Error in snapnow (line 144)
                        data = leavingCell(iCell(k), data, doCapture(k));

Error in evalmxdom&gt;instrumentAndRun (line 116)
text = evalc(evalstr);

Error in evalmxdom (line 21)
[data,text,laste] = instrumentAndRun(file,cellBoundaries,imageDir,imagePrefix,options);

Error in publish

Error in connector.internal.fevalMatlab

Error in connector.internal.fevalJSON

Error in internal.matlab.publish.captureFigures (line 15)
drawnow;

Error in internal.matlab.publish.PublishFigures/leavingCell (line 84)
            newFigures = internal.matlab.publish.captureFigures;

Error in snapnow&gt;leavingCell (line 212)
            newFiles = data.plugins(iPlugins).instance.leavingCell(iCell);

Error in snapnow (line 144)
                        data = leavingCell(iCell(k), data, doCapture(k));

Error in comp572_photo_mosics&gt;generate_mosaics (line 51)
    result = zeros(size(target_im));

Error in comp572_photo_mosics (line 41)
    im_mosaic = generate_mosaics(target_im, im_list, subim_size);

Error in evalmxdom&gt;instrumentAndRun (line 116)
text = evalc(evalstr);

Error in evalmxdom (line 21)
[data,text,laste] = instrumentAndRun(file,cellBoundaries,imageDir,imagePrefix,options);

Error in publish

Error in connector.internal.fevalMatlab

Error in connector.internal.fevalJSON

Caused by:
    Error using checkArgsForHandleToPrint
    Handle input argument contains nonhandle values.
</pre><pre class="codeinput"><span class="keyword">function</span> result = generate_mosaics(target_im, im_list, subim_size)
<span class="comment">%subim_size is the size of the blocks of subimages within the whole mosaic</span>
<span class="comment">%picture and such blocks are assumed to be squares</span>
    result = zeros(size(target_im));
    result = im2uint8(result);
    colors = vertcat(im_list.color);
    [y,x,~] = size(target_im);

<span class="comment">%conditions on when y/x has residuals when divided by size of blocks</span>
    <span class="keyword">if</span> mod(y,subim_size)==0
        y_num = [1:subim_size:y,y+1];
    <span class="keyword">else</span>
        y_margin = floor((y - floor(y/subim_size)*subim_size) )+1;
        y_num = [1, y_margin:subim_size:y, y+1];
    <span class="keyword">end</span>
    <span class="keyword">if</span> mod(x,subim_size)==0
        x_num = [1:subim_size:x,x+1];
    <span class="keyword">else</span>
        x_margin = floor((x - floor(x/subim_size)*subim_size) )+1;
        x_num = [1, x_margin:subim_size:x, x+1];
    <span class="keyword">end</span>

    <span class="keyword">for</span> j=1:length(y_num)-1
        y_be = y_num(j);
        y_ed = y_num(j+1)-1;
        <span class="keyword">for</span> i=1:length(x_num)-1
            x_be = x_num(i);
            x_ed=x_num(i+1)-1;
            <span class="keyword">try</span>
            block = target_im(y_be:y_ed, x_be:x_ed, :);
            <span class="keyword">catch</span>
                disp(<span class="string">"error"</span>);
                fprintf(<span class="string">"j = %d, i = %d\n"</span>, j, i);

            <span class="keyword">end</span>
            block_color = get_mean_color(block);
<span class="comment">%square distance between the mean color of picture and the target block is</span>
<span class="comment">%used to choose similar imagesfor mosaics</span>
            color_distance = colors - block_color;
            square_dis = sum((color_distance).^2,2);

<span class="comment">%to introduce randomness, one the three pics with the closet distance is randomly chosen</span>
            [~, indexes] = mink(square_dis, 3);
            index = randsample(3, 1);

            im_url = im_list(indexes(index)).url;
            mosaic_im = imread(im_url,<span class="string">'jpg'</span>);
                mosaic_im = imresize(mosaic_im, [y_ed-y_be+1 x_ed-x_be+1]);
                result(y_be:y_ed, x_be:x_ed, :) = mosaic_im(:,:,:);

        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> photos = get_photos()
<span class="comment">%api generated on website https://www.flickr.com/services/apps/create/noncommercial/?</span>
<span class="comment">%url generated on website https://www.flickr.com/services/api/explore/flickr.photos.getRecent</span>
    photos = [];
    <span class="keyword">for</span> i = 1:1
        url = <span class="string">"https://www.flickr.com/services/rest/?method=flickr.photos.getRecent&amp;api_key=dfab7aa5a5d01718e22061a58f3595ef&amp;per_page=500&amp;page="</span>+ int2str(i)+<span class="string">"&amp;format=json"</span>;
        data = webread(url);

        prefix = <span class="string">"jsonFlickrApi("</span>;
        suffix = <span class="string">")"</span>;
        regex  = [[<span class="string">'^'</span> prefix],[suffix <span class="string">'$'</span>]];
        replacements = [<span class="string">''</span>, <span class="string">''</span>];
        data = regexprep(data, regex, replacements);

        value = jsondecode(data);
        photos = cat(1, photos, value.photos.photo);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> color = get_mean_color(im)
    red = mean2(im(:, :, 1));
    green = mean2(im(:, :, 2));
    blue = mean2(im(:, :, 3));
    color = [red green blue];
<span class="keyword">end</span>

<span class="comment">%filter grayscale images</span>
<span class="keyword">function</span> imdata = get_flickr_images(info)
    url = <span class="string">"https://live.staticflickr.com/"</span>+info.server+<span class="string">"/"</span>+info.id+<span class="string">"_"</span>+info.secret+<span class="string">"_s.jpg"</span>;
    <span class="keyword">try</span>
        im = imread(url, <span class="string">'jpg'</span>);
        [~, ~, numberOfColorChannels] = size(im);
        <span class="keyword">if</span> numberOfColorChannels &gt; 1
            is_rgb = 1;
            color = get_mean_color(im);
            imdata = struct(<span class="string">"url"</span>, url, <span class="string">"color"</span>, color, <span class="string">"isrgb"</span>, is_rgb);
        <span class="keyword">else</span>
            is_rgb =0;
            imdata = struct(<span class="string">"url"</span>, url, <span class="string">"color"</span>, [], <span class="string">"isrgb"</span>, is_rgb);
        <span class="keyword">end</span>
    <span class="keyword">catch</span>
        fprintf(<span class="string">"images not found are skipped"</span>)
        imdata =struct(<span class="string">"url"</span>, <span class="string">""</span>, <span class="string">"color"</span>, [], <span class="string">"isrgb"</span>, 0);
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022b</a><br></p></div><!--
##### SOURCE BEGIN #####
%How you downloaded the corpus of images
% In my project, I used flickr.photos.getRecent to get the photos
% downloaded. API keys and website are autogenerated on flickr. 

%How you determine the quality of match 
%I use mean color to match the image to a certain block. (Mean color on three channels)
%Then I used square of the (sum of the difference between the image and a
%certain block on three channels) to find the distance between the block
%and image. Then I choose three pictures with the least distance. 


%A targeted image is divided into blocks, if width and height cannot be
%divided by block_size, then margin is utilized. 

%Introduce randomness
%As I selected the three pictures with least distance, one of them is
%randonly chosen to be the image put into the block.

infos=get_photos();
im_num = size(infos, 1);
%an image is stored with the link of the images, values for the color of
%the image, isrgb tells whether a images is grayscale or 
imdata_list = struct( "url", cell(im_num, 1),"color", cell(im_num, 1), "isrgb", cell(im_num, 1));
for i = 1:im_num
    imdata = get_flickr_images(infos(i));
    imdata_list(i) = imdata;
end

im_list = imdata_list([imdata_list.isrgb] == 1);

base_url = "https://raw.githubusercontent.com/cpysleeper/comp572hw4/main/";
target_ims = ["final_photo_by_me.jpg","knifes.jpg","Cat03.jpg","sun%20and%20hill.jpg","grass%20.jpg"];

for i = 1:length(target_ims)
%for a whole mosaic image, there are 50x50 blocks, each small block is an
%image
    subim_size = 40;

    url = base_url + target_ims(i);
    target_im = imread(url);
    im_mosaic = generate_mosaics(target_im, im_list, subim_size);
    figure; subplot(1, 2, 1), imshow(target_im);
    subplot(1, 2, 2), imshow(im_mosaic);
end


%%
function result = generate_mosaics(target_im, im_list, subim_size)
%subim_size is the size of the blocks of subimages within the whole mosaic
%picture and such blocks are assumed to be squares
    result = zeros(size(target_im));
    result = im2uint8(result);
    colors = vertcat(im_list.color);
    [y,x,~] = size(target_im);

%conditions on when y/x has residuals when divided by size of blocks 
    if mod(y,subim_size)==0
        y_num = [1:subim_size:y,y+1];
    else
        y_margin = floor((y - floor(y/subim_size)*subim_size) )+1;
        y_num = [1, y_margin:subim_size:y, y+1];
    end
    if mod(x,subim_size)==0
        x_num = [1:subim_size:x,x+1];
    else
        x_margin = floor((x - floor(x/subim_size)*subim_size) )+1;
        x_num = [1, x_margin:subim_size:x, x+1];
    end
    
    for j=1:length(y_num)-1
        y_be = y_num(j);
        y_ed = y_num(j+1)-1;
        for i=1:length(x_num)-1
            x_be = x_num(i);
            x_ed=x_num(i+1)-1;
            try
            block = target_im(y_be:y_ed, x_be:x_ed, :);
            catch 
                disp("error");
                fprintf("j = %d, i = %d\n", j, i);
                
            end
            block_color = get_mean_color(block);
%square distance between the mean color of picture and the target block is
%used to choose similar imagesfor mosaics
            color_distance = colors - block_color;
            square_dis = sum((color_distance).^2,2);
            
%to introduce randomness, one the three pics with the closet distance is randomly chosen
            [~, indexes] = mink(square_dis, 3);
            index = randsample(3, 1);
            
            im_url = im_list(indexes(index)).url;
            mosaic_im = imread(im_url,'jpg');
                mosaic_im = imresize(mosaic_im, [y_ed-y_be+1 x_ed-x_be+1]);
                result(y_be:y_ed, x_be:x_ed, :) = mosaic_im(:,:,:);
            
        end
    end
end

function photos = get_photos()
%api generated on website https://www.flickr.com/services/apps/create/noncommercial/?
%url generated on website https://www.flickr.com/services/api/explore/flickr.photos.getRecent    
    photos = [];
    for i = 1:1
        url = "https://www.flickr.com/services/rest/?method=flickr.photos.getRecent&api_key=dfab7aa5a5d01718e22061a58f3595ef&per_page=500&page="+ int2str(i)+"&format=json";
        data = webread(url);

        prefix = "jsonFlickrApi(";
        suffix = ")";
        regex  = [['^' prefix],[suffix '$']];
        replacements = ['', ''];
        data = regexprep(data, regex, replacements);

        value = jsondecode(data);
        photos = cat(1, photos, value.photos.photo);
    end
end

function color = get_mean_color(im)
    red = mean2(im(:, :, 1));
    green = mean2(im(:, :, 2));
    blue = mean2(im(:, :, 3));
    color = [red green blue];
end

%filter grayscale images
function imdata = get_flickr_images(info)
    url = "https://live.staticflickr.com/"+info.server+"/"+info.id+"_"+info.secret+"_s.jpg";
    try
        im = imread(url, 'jpg');
        [~, ~, numberOfColorChannels] = size(im);
        if numberOfColorChannels > 1
            is_rgb = 1;
            color = get_mean_color(im);
            imdata = struct("url", url, "color", color, "isrgb", is_rgb);
        else
            is_rgb =0;
            imdata = struct("url", url, "color", [], "isrgb", is_rgb);
        end
    catch
        fprintf("images not found are skipped")
        imdata =struct("url", "", "color", [], "isrgb", 0);
    end
end
##### SOURCE END #####
--></body></html>